<script>
    document.addEventListener('DOMContentLoaded', function () {
        const kitItems = document.querySelectorAll('.kit-item');
        const mainView = document.querySelector('.kit-main-view');
        const historyBtn = document.getElementById('history-btn');

        mainView.innerHTML = '<p class="placeholder">Aguardando seleção de kit...</p>';

        // =========================================================
        // === 1. API INTERNA SIMULADA (Estrutura de Dados) ========
        // A fonte de verdade para o nome e conteúdo de cada kit.
        // =========================================================
        const kitsData = Array.from(kitItems).map((item, index) => {
            const nomeInicial = item.querySelector('.kit-btn').textContent.trim();
            return {
                id: index + 1,
                nome: nomeInicial,
                conteudo: [] // Simulação de dados do kit (vazio por enquanto)
            };
        });

        // Função para atualizar o nome do kit na estrutura de dados
        function updateKitName(kitId, novoNome) {
            const kit = kitsData.find(k => k.id === kitId);
            if (kit) {
                kit.nome = novoNome;
            }
        }
        
        // Função para atualizar o nome do kit no HTML
        function updateKitButtonText(kitIndex, novoNome) {
            kitItems[kitIndex].querySelector('.kit-btn').textContent = novoNome;
        }


        // =========================================================
        // === 2. LÓGICA DE INTERAÇÃO (Usando a nova estrutura) ====
        // =========================================================
        kitItems.forEach((item, index) => {
            const kitButton = item.querySelector('.kit-btn');
            const renameButton = item.querySelector('.renomear');
            const deleteButton = item.querySelector('.deletar');
            const accessButton = item.querySelector('.acessar');
            const kitId = index + 1; // ID baseado na posição (1 a 6)

            kitButton.addEventListener('click', function () {
                kitItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
            });

            accessButton.addEventListener('click', function (event) {
                event.stopPropagation();
                // Pega o nome mais recente do kitsData
                const nomeKit = kitsData.find(k => k.id === kitId).nome;
                mainView.innerHTML = `<p> Exibindo informações de <strong>${nomeKit}</strong></p>`;
                showMessage(`Kit "${nomeKit}" acessado.`, true);
            });

            deleteButton.addEventListener('click', function (event) {
                event.stopPropagation();
                openPopupConfirm({
                    message: "Deseja realmente limpar os dados do kit?",
                    onConfirm: () => {
                        const nomePadrao = `Kit ${kitId}`;
                        updateKitName(kitId, nomePadrao); // Atualiza dados
                        updateKitButtonText(index, nomePadrao); // Atualiza HTML
                        mainView.innerHTML = '<p class="placeholder">Aguardando seleção de kit...</p>';
                        showMessage("Kit redefinido com sucesso!", true);
                    },
                    onCancel: () => {
                        showMessage("Ação cancelada.", false);
                    }
                });
            });

            renameButton.addEventListener('click', function (event) {
                event.stopPropagation();
                // Pega o nome atualizado da estrutura de dados
                const nomeAtual = kitsData.find(k => k.id === kitId).nome; 
                openPopupRename({
                    currentName: nomeAtual,
                    onConfirm: (novoNome) => {
                        if (novoNome && novoNome.trim() !== "") {
                            const nomeFinal = novoNome.trim();
                            updateKitName(kitId, nomeFinal); // Atualiza dados (API)
                            updateKitButtonText(index, nomeFinal); // Atualiza HTML (UI)
                            showMessage("Kit renomeado com sucesso!", true);
                        } else {
                            showMessage("Nome inválido. Nenhuma alteração feita.", false);
                        }
                    }
                });
            });
        });

        // === Botão de Histórico ===
        historyBtn.addEventListener('click', () => {
            openHistoryPopup();
        });

        // =========================================================
        // === 3. FUNÇÕES DE POP-UP (openHistoryPopup e openSalvarComoPopup atualizadas) ====
        // =========================================================

        function openPopupConfirm({ message, onConfirm, onCancel }) {
            const overlay = document.createElement('div');
            overlay.classList.add('popup-overlay');
            overlay.innerHTML = `
                <div class="popup">
                    <h3>${message}</h3>
                    <button id="confirmar">Confirmar</button>
                    <button id="cancelar">Cancelar</button>
                </div>
            `;
            document.body.appendChild(overlay);
            overlay.style.display = 'flex';

            overlay.querySelector('#confirmar').addEventListener('click', () => {
                overlay.remove();
                onConfirm();
            });

            overlay.querySelector('#cancelar').addEventListener('click', () => {
                overlay.remove();
                onCancel();
            });
        }

        function openPopupRename({ currentName, onConfirm }) {
            const overlay = document.createElement('div');
            overlay.classList.add('popup-overlay');
            overlay.innerHTML = `
                <div class="popup">
                    <h3>Renomear Kit</h3>
                    <input type="text" id="novoNome" value="${currentName}">
                    <div>
                        <button id="confirmar">Confirmar</button>
                        <button id="cancelar">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            overlay.style.display = 'flex';
            const input = overlay.querySelector('#novoNome');
            input.focus();

            overlay.querySelector('#confirmar').addEventListener('click', () => {
                const novoNome = input.value;
                overlay.remove();
                onConfirm(novoNome);
            });

            overlay.querySelector('#cancelar').addEventListener('click', () => {
                overlay.remove();
                showMessage("Ação cancelada.", false);
            });
        }

        // Função de Histórico - CORRIGIDA COM BOTÃO DE FECHAR
        function openHistoryPopup() {
            const overlay = document.createElement('div');
            overlay.classList.add('popup-overlay');
            
            overlay.innerHTML = `
                <div class="popup large">
                    <button class="popup-close"><i class="fas fa-times"></i></button> <h3>Último pedido</h3>
                    <div class="materials-list">
                        <ul>
                            <li>Cabo Vinicius Tipo A</li>
                            <li>Placa do Uno</li>
                            <li>Cabo Vinicius Tipo B</li>
                            <li>Cabo Vinicius Tipo C</li>
                            <li>Cabo Vinicius Tipo D</li>
                            <li>Cabo Vinicius Tipo gay</li>
                            <li>Cabo Vinicius Tipo gay</li>
                            <li>Cabo Vinicius Tipo gay</li>
                            <li>Cabo Vinicius Tipo gay</li>
                            <li>Cabo Vinicius Tipo gay</li>
                            <li>Cabo Vinicius Tipo gay</li>
                        </ul>
                    </div>
                    <div> 
                        <button id="salvarComo">Salvar como</button>
                        <button id="voltar">Voltar</button> 
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);
            overlay.style.display = 'flex';

            const closePopup = () => overlay.remove();
            
            overlay.querySelector('#voltar').addEventListener('click', closePopup);
            overlay.querySelector('.popup-close').addEventListener('click', closePopup); // Lógica para fechar no 'X'

            overlay.querySelector('#salvarComo').addEventListener('click', () => {
                closePopup();
                openSalvarComoPopup();
            });
        }


        function openSalvarComoPopup() {
            const overlay = document.createElement('div');
            overlay.classList.add('popup-overlay');

            // GERAÇÃO DOS BOTÕES COM OS NOMES ATUALIZADOS DO kitsData
            const kitOptionsHTML = kitsData.map(kit => 
                `<button class="kitOption" data-kit-id="${kit.id}">${kit.nome}</button>`
            ).join('');

            overlay.innerHTML = `
                <div class="popup">
                    <h3>Salvar conteúdo em:</h3>
                    <div id="kitOptions">
                        ${kitOptionsHTML}
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            overlay.style.display = 'flex';

            overlay.querySelectorAll('.kitOption').forEach(btn => {
                btn.addEventListener('click', () => {
                    const nomeKit = btn.textContent;
                    const kitId = parseInt(btn.getAttribute('data-kit-id'));
                    overlay.remove();
                    
                    openPopupConfirm({
                        message: `Deseja substituir o conteúdo de ${nomeKit}?`,
                        onConfirm: () => {
                            openPopupRename({
                                currentName: nomeKit,
                                onConfirm: (novoNome) => {
                                    if (novoNome && novoNome.trim() !== "") {
                                        const nomeFinal = novoNome.trim();
                                        updateKitName(kitId, nomeFinal); // Atualiza dados (API)
                                        updateKitButtonText(kitId - 1, nomeFinal); // Atualiza HTML (UI)
                                        showMessage(`Conteúdo salvo em "${nomeFinal}"!`, true);
                                    } else {
                                        showMessage("Ação de salvamento cancelada: nome inválido.", false);
                                    }
                                }
                            });
                        },
                        onCancel: () => {
                            showMessage("Ação cancelada.", false);
                        }
                    });
                });
            });
        }

        // Mensagem flutuante
        function showMessage(text, success) {
            const msg = document.createElement('div');
            msg.classList.add('popup-message');
            msg.textContent = text;
            msg.style.backgroundColor = success ? '#d4edda' : '#f8d7da';
            msg.style.color = success ? '#155724' : '#721c24';
            document.body.appendChild(msg);
            msg.style.display = 'block';
            setTimeout(() => {
                msg.remove();
            }, 2500);
        }
    });


    window.addEventListener('DOMContentLoaded', () => { 
        const params = new URLSearchParams(window.location.search);
        if (params.get('reserva') === 'sucesso') {
            const notification = document.getElementById('notification');
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000); 
        }
    });

</script>